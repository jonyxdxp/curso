generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String?
  nombre    String
  avatarUrl String?  @map("avatar_url")
  rol       UserRole @default(estudiante)
  estado    UserEstado @default(activo)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relaciones
  estudiante Estudiante?
  profesor   Profesor?

  @@map("users")
}

model Estudiante {
  id                   String              @id @default(uuid())
  userId               String              @unique @map("user_id")
  estadoAprobacion     EstadoAprobacion    @default(pendiente) @map("estado_aprobacion")
  estadoPago           EstadoPago          @default(no_pagado) @map("estado_pago")
  fechaAprobacion      DateTime?           @map("fecha_aprobacion")
  fechaPago            DateTime?           @map("fecha_pago")
  montoPagado          Decimal?            @map("monto_pagado") @db.Decimal(10, 2)
  metodoPago           String?             @map("metodo_pago")
  referenciaTransaccion String?            @map("referencia_transaccion") @unique
  telefono             String?
  pais                 String?
  experiencia          String?             @db.Text
  interes              String?             @db.Text
  fechaInscripcion     DateTime?           @map("fecha_inscripcion")
  
  // Relaciones
  user                 User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  progreso             ProgresoEstudiante[]
  pagos                Pago[]
  solicitud            SolicitudAcceso?

  @@map("estudiantes")
}

model Profesor {
  id          String   @id @default(uuid())
  userId      String   @unique @map("user_id")
  permisos    String[] @default([])
  ultimoLogin DateTime? @map("ultimo_login")
  
  // Relaciones
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  configuracion ConfiguracionProfesor?

  @@map("profesores")
}

model SolicitudAcceso {
  id              String          @id @default(uuid())
  estudianteId    String?         @unique @map("estudiante_id")
  nombre          String
  email           String
  telefono        String?
  pais            String?
  experiencia     String?         @db.Text
  interes         String?         @db.Text
  estado          EstadoSolicitud @default(pendiente)
  fechaSolicitud  DateTime        @default(now()) @map("fecha_solicitud")
  fechaRevision   DateTime?       @map("fecha_revision")
  motivoRechazo   String?         @map("motivo_rechazo") @db.Text
  createdAt       DateTime        @default(now()) @map("created_at")

  // Relaciones
  estudiante Estudiante? @relation(fields: [estudianteId], references: [id])

  @@map("solicitudes_acceso")
}

model Modulo {
  id              String    @id @default(uuid())
  titulo          String
  descripcion     String?   @db.Text
  orden           Int       @default(0)
  moduloPrevioId  String?   @map("modulo_previo_id")
  estado          EstadoModulo @default(borrador)
  duracion        String?   @default("2 semanas")
  objetivos       String[]  @default([])
  ejercicio       Json?     // { titulo, descripcion, deadline }
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relaciones
  progreso ProgresoEstudiante[]
  contenido ContenidoModulo[]

  @@map("modulos")
}

model ContenidoModulo {
  id          String       @id @default(uuid())
  moduloId    String       @map("modulo_id")
  tipo        TipoContenido
  titulo      String?
  descripcion String?      @db.Text
  url         String?      // Para videos, PDFs, Zoom links, im√°genes
  texto       String?      @db.Text // Para contenido de texto
  orden       Int          @default(0)
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  modulo Modulo @relation(fields: [moduloId], references: [id], onDelete: Cascade)

  @@map("contenido_modulos")
}

model ProgresoEstudiante {
  id                  String    @id @default(uuid())
  estudianteId        String    @map("estudiante_id")
  moduloId            String    @map("modulo_id")
  completudPorcentaje Int       @default(0) @map("completud_porcentaje")
  fechaCompletado     DateTime? @map("fecha_completado")
  ultimaActividad     DateTime? @map("ultima_actividad")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // Relaciones
  estudiante Estudiante @relation(fields: [estudianteId], references: [id], onDelete: Cascade)
  modulo     Modulo     @relation(fields: [moduloId], references: [id], onDelete: Cascade)

  @@unique([estudianteId, moduloId])
  @@map("progreso_estudiante")
}

model Pago {
  id                String      @id @default(uuid())
  estudianteId      String      @map("estudiante_id")
  monto             Decimal     @db.Decimal(10, 2)
  moneda            String      @default("USD")
  proveedor         String      // 'stripe', 'mercadopago', etc.
  referenciaExterna String      @map("referencia_externa")
  estado            EstadoPagoTransaccion @default(pendiente)
  fechaPago         DateTime?   @map("fecha_pago")
  createdAt         DateTime    @default(now()) @map("created_at")

  // Relaciones
  estudiante Estudiante @relation(fields: [estudianteId], references: [id], onDelete: Cascade)

  @@map("pagos")
}

model ConfiguracionProfesor {
  id                String    @id @default(uuid())
  profesorId        String    @unique @map("profesor_id")
  nombreCurso       String    @map("nombre_curso")
  descripcionCurso  String?   @map("descripcion_curso") @db.Text
  precioCurso       Decimal   @map("precio_curso") @db.Decimal(10, 2)
  moneda            String    @default("USD")
  bioProfesor       String?   @map("bio_profesor") @db.Text
  fotoProfesorUrl   String?   @map("foto_profesor_url")
  emailContacto     String?   @map("email_contacto")
  whatsappNumero    String?   @map("whatsapp_numero")
  pais              String?
  stripeSecretKey   String?   @map("stripe_secret_key")
  stripePublicKey   String?   @map("stripe_public_key")
  stripeWebhookSecret String? @map("stripe_webhook_secret")
  emailNotificaciones String? @map("email_notificaciones")
  notificarWhatsApp Boolean   @default(false) @map("notificar_whatsapp")
  notificarEmail    Boolean   @default(true) @map("notificar_email")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relaciones
  profesor Profesor @relation(fields: [profesorId], references: [id], onDelete: Cascade)

  @@map("configuracion_profesor")
}

// Enums
enum UserRole {
  profesor
  estudiante
}

enum UserEstado {
  activo
  inactivo
}

enum EstadoAprobacion {
  pendiente
  aprobado
  rechazado
}

enum EstadoPago {
  no_pagado
  pagado
  cancelado
}

enum EstadoSolicitud {
  pendiente
  aprobado
  rechazado
}

enum EstadoModulo {
  borrador
  publicado
}

enum TipoContenido {
  texto
  video
  pdf
  zoom
  imagen
}

enum EstadoPagoTransaccion {
  pendiente
  completado
  fallido
  reembolsado
}
